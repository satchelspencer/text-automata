<!doctype html>
<html>
	<head>
		<title>text-automata</title>
		<link href="style.css" rel="stylesheet">
		<script src="bower_components/jquery/dist/jquery.min.js"></script>
		<script src="bower_components/underscore/underscore-min.js"></script>
		<script>
			var cellSize = 15;
			var boardSize = 40;
			var cells = _.map(new Array(boardSize), function(row){
			    return new Array(boardSize);
			});
			var board;

			/* init */
			$(function(){
				board = $('.board');
				/* init cells */
				_.times(boardSize, function(i){
					var row = $('<div>').addClass('row');
					_.times(boardSize, function(j){
						var cell = $('<div>').addClass('cell').css({
							width : cellSize,
							height : cellSize,
							fontSize : cellSize*0.8
						}).click(function(){
							$('.cell').removeClass('selected');
							cell.addClass('selected');
						}).on('set', function(ev, val){
							cell.text(val);
							cells[i][j] = val;
						});
						row.append(cell);
					})
					board.append(row);
				})

				$(window).on('keyup', function(e){
					var selected = $('.cell.selected');
					if(e.which > 64 && e.which < 91 || e.which == 8 || e.which == 32){
						val = e.which == 8?'':e.key;
						selected.trigger('set', val);
						if(e.which == 8) selected.prev().click();
						else selected.next().click();
					} 
				})
			})

			/* display a given state */
			function display(cells){
				board.children().each(function(i){
					$(this).children().each(function(j){
						$(this).text(cells[i][j]);
					})
				})
			}

			function apply(cells, predicate){
				ncels = JSON.parse(JSON.stringify(cells));
				return _.map(ncels, function(row, i){
					return _.map(row, function(cell, j){
						return predicate(cell, i, j, cells);
					})
				})
			}

			function step(predicate){
				cells = apply(cells, predicate);
				display(cells);
			}

			function neighbors(i, j, cells){
				var n = [];
				var span = _.range(-2, 3);
				_.each(span, function(io){
					_.each(span, function(jo){
						n.push(cells[i+io]&&cells[i+io][j+jo]);
					})
				})
				return n;
			}

			function nei(val, i, j, cells){
				var n = _.compact(neighbors(i, j, cells)).length;
				return n > 4 || n < 3?'':'o';
			}
		</script>
	</head>
	<body>
		<div class="board"></div>
	</body>
</html>