<!doctype html>
<html>
	<head>
		<title>text-automata</title>
		<link href="style.css" rel="stylesheet">
		<script src="bower_components/jquery/dist/jquery.min.js"></script>
		<script src="bower_components/underscore/underscore-min.js"></script>
		<script>
			var cellSize = 15;
			var boardSize = 30;
			var cells = _.map(new Array(boardSize), function(row){
			    return new Array(boardSize);
			});
			var board;

			/* init */
			$(function(){
				board = $('.board');
				/* init cells */
				_.times(boardSize, function(i){
					var row = $('<div>').addClass('row');
					_.times(boardSize, function(j){
						var cell = $('<div>').addClass('cell').css({
							width : cellSize,
							height : cellSize,
							fontSize : cellSize*0.8
						}).click(function(){
							$('.cell').removeClass('selected');
							cell.addClass('selected');
						}).on('set', function(ev, val){
							cell.text(val);
							cells[i][j] = val;
						});
						row.append(cell);
					})
					board.append(row);
				})

				$(window).on('keyup', function(e){
					var selected = $('.cell.selected');
					if(e.which > 64 && e.which < 91 || e.which == 8 || e.which == 32){
						val = e.which == 8?'':e.key;
						selected.trigger('set', val);
						if(e.which == 8) selected.prev().click();
						else selected.next().click();
					} 
				})
			})

			/* display a given state */
			function display(cells){
				board.children().each(function(i){
					$(this).children().each(function(j){
						$(this).text(cells[i][j]);
					})
				})
			}

			function apply(cells, predicate){
				return _.map(cells, function(row, i){
					return _.map(row, function(cell, j){
						// $('.cell').removeClass('on');
						// board.children().eq(i).children().eq(j).addClass('on');
						return predicate(cell, i, j, cells);
					})
				})
			}

			function applySeq(cells, predicate){
				_.each(cells, function(row, i){
					_.each(row, function(cell, j){
						cells[i][j] = predicate(cell, i, j, cells);
					})
				})
				return cells;
			}

			function applyRandomly(cells, predicate){
				var rowindices = _.shuffle(_.range(cells.length));
				_.each(rowindices, function(i){
					var colindicies = _.shuffle(_.range(cells[i].length));
					_.each(colindicies, function(j){
						cells[i][j] = predicate(cells[i][j], i, j, cells);
					})
				})
				return cells;
			}

			function step(predicate){
				cells = applyRandomly(cells, predicate);
				display(cells);
			}

			function neighbors(i, j, cells){
				var n = [];
				var span = _.range(-4, 5);
				_.each(span, function(io){
					_.each(span, function(jo){
						n.push(cells[i+io]&&cells[i+io][j+jo]);
					})
				})
				return n;
			}

			function nei(val, i, j, cells){
				var n = _.compact(neighbors(i, j, cells)).length;
				return n < 5 || n > 10 ?'':'x';
			}

			var dictionary = ['the', 'real', 'lemon', 'squeezer', 'remains', 'unfound', 'drills', 'emaild'];
			function spellero(val, i, j, cells){
				if(val) return val; //no death yet
				else{
					var dirs = [[0,1],[1,0],[0,-1],[-1,0]];
					var possibles = _.chain(dirs).map(function(dir){
						var ii = i;
						var ji = j;
						var n = 1;
						var word = [];
						while(n){
							ii += dir[0];
							ji += dir[1];
							n = cells[ii]&&cells[ii][ji];
							if(n){
								if(dir[1]+dir[0] < 0) word.push(n);
								 word.unshift(n);
							}
						}
						if(word.length) {
							var runners = _.filter(dictionary, function(dword){
								return _.first(dword, word.length).join('') == word.join('');
							})
							var chosen = runners[Math.floor(Math.random()*runners.length)];
							return chosen&&chosen[word.length]; //next char
						}
					}).compact().uniq().value();
					if(possibles.length == 1) return possibles[0];
					else return '';
				}
			}

			function speller(val, i, j, cells){
				if(val) return val; //no death yet
				else{
					var dirs = [[0,1],[1,0],[0,-1],[-1,0]]; //down, right, up, left
					var neighbors = 0;
					var possibles = _.chain(dirs).map(function(dir){
						if(cells[i+dir[0]]&&cells[i+dir[0]][j+dir[1]]) neighbors++; //if its even there
						var ii = i;
						var ji = j;
						var reverse = dir[0]+dir[1] < 0;
						var n; //next char
						var segment = '';
						do{	
							ii += dir[0];
							ji += dir[1];
							n = cells[ii]&&cells[ii][ji];
							if(n){
								if(reverse) segment = n+segment;
								else segment = segment+n;
							}
						}while(n);
						if(segment.length){
							var word = _.find(dictionary, function(dword){
								var dwordsegment = _[reverse?'first':'last'](dword, segment.length);
								return dwordsegment.join('') == segment;
							})
							return word&&word[reverse?segment.length:(word.length-segment.length-1)]; //
						}
					}).compact().value();
					if(possibles.length != 1 || neighbors > 1) return '';
					else return possibles[0];
				}
			}
		</script>
	</head>
	<body>
		<div class="board"></div>
	</body>
</html>